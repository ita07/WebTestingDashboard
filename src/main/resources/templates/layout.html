<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle != null ? pageTitle : 'Web Testing Dashboard'}">Web Testing Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
<div id="toast-container" class="toast-container"></div>
<div class="dashboard-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-tachometer-alt"></i> Web Testing Dashboard</h2>
        </div>
        <ul class="sidebar-menu">
            <li><a th:href="@{/dashboard}" th:class="${activeTab == 'dashboard' ? 'active' : ''}"><i
                    class="fas fa-home"></i> Dashboard</a></li>
            <li><a th:href="@{/test-builder}" th:class="${activeTab == 'test-builder' ? 'active' : ''}"><i
                    class="fas fa-hammer"></i> Test Builder</a></li>
            <li><a th:href="@{/analytics}" th:class="${activeTab == 'analytics' ? 'active' : ''}"><i
                    class="fas fa-chart-line"></i> Analytics</a></li>
            <li><a th:href="@{/reports}" th:class="${activeTab == 'reports' ? 'active' : ''}"><i
                    class="fas fa-file-alt"></i> Reports</a></li>
            <li><a th:href="@{/settings}" th:class="${activeTab == 'settings' ? 'active' : ''}"><i
                    class="fas fa-cog"></i> Settings</a></li>
            <li><a href="#" id="logout-link" style="color: red;" onclick="logout()"><i class="fas fa-sign-out-alt"></i>
                Logout</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="top-bar">
            <h3><i class="fas fa-user"></i> Welcome, Admin</h3>
        </div>
        <div class="content">
            <!-- Main content area that gets populated with the current view -->
            <div th:if="${view != null}" th:replace="~{${view} :: content}"></div>
            <div th:unless="${view != null}" id="default-content">
                <h2>Welcome to Web Testing Dashboard</h2>
                <p>Please select a tab from the sidebar.</p>
            </div>
        </div>
    </div>
</div>

<script>
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            fetch('/logout', {
                method: 'POST',
                credentials: 'include'
            }).then(() => {
                window.location.href = '/login?logout';
            }).catch(error => {
                console.error('Logout failed:', error);
                showToast("Logout failed. Please try again.", "error");
            });
        }
    }

    // Toast notification system
    function showToast(message, type = "info", duration = 5000) {
        const toastContainer = document.getElementById('toast-container');

        // Clear any existing toasts
        toastContainer.innerHTML = '';

        const toast = document.createElement('div');

        // Generate a unique ID for this toast
        const toastId = 'toast-' + Date.now();
        toast.id = toastId;
        toast.className = `popup-message ${type}`;

        // Create message content in a separate element
        const messageElement = document.createElement('span');
        messageElement.className = 'popup-message-content';
        messageElement.innerHTML = message;

        // Create close button
        const closeButton = document.createElement('span');
        closeButton.className = 'popup-message-close';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = () => removeToast(toastId);

        // Add message and close button to toast
        toast.appendChild(messageElement);
        toast.appendChild(closeButton);

        // Add to container
        toastContainer.appendChild(toast);

        // Show the toast
        setTimeout(() => {
            toast.style.display = 'block';
        }, 10);

        // Auto-remove after duration
        if (duration > 0) {
            setTimeout(() => removeToast(toastId), duration);
        }

        return toastId;
    }

    function removeToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            // Add fade-out animation before removing
            toast.style.animation = 'fadeOut 0.3s ease-out forwards';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Form submission handling
        function setupFormHandlers() {
            // Settings form handler
            const settingsForm = document.getElementById('settings-form');
            if (settingsForm) {
                settingsForm.addEventListener('submit', function (e) {
                    e.preventDefault(); // Prevent default form submission
                    handleFormSubmit(settingsForm, '/api/settings/update', 'Settings updated successfully.');
                });
            }

            // Generic form submission handler for AJAX forms
            function handleFormSubmit(form, endpoint, successMessage) {
                const formData = new FormData(form);

                // Show loading indicator
                showToast('Processing...', 'info');

                fetch(endpoint, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    showToast(data || successMessage, "success");
                })
                .catch(error => {
                    console.error(`Error submitting to ${endpoint}:`, error);
                    showToast("An error occurred. Please try again.", "error");
                });
            }
        }

        // Initialize all form handlers
        setupFormHandlers();

        const initRunTestPage = async () => {
            const addActionBtn = document.getElementById('add-action-btn');
            const actionsContainer = document.getElementById('actions-container');
            const jsonPreview = document.getElementById('json-preview');
            const form = document.getElementById('test-builder-form');

            if (!form || !addActionBtn || !actionsContainer || !jsonPreview) {
                showToast('Some required elements for the Test Builder are missing. Please refresh the page or contact support if the issue persists.', "error");
                return;
            }

            let actionDefinitions = {};
            let locatorTypes = [];
            let selectByTypes = [];

            // Fetch all required data
            try {
                const [actionsResponse, locatorTypesResponse, selectByTypesResponse] = await Promise.all([
                    fetch('/api/actions'),
                    fetch('/api/actions/locators'),
                    fetch('/api/actions/select-by')
                ]);
                actionDefinitions = await actionsResponse.json();
                locatorTypes = await locatorTypesResponse.json();
                selectByTypes = await selectByTypesResponse.json();
            } catch (error) {
                showToast('Failed to load Test Builder data. Please try again or contact support if the issue persists.', "error");
                return;
            }

            // Create input field based on parameter type
            const createInputField = (param, key) => {
                switch (param) {
                    case 'locator.type':
                    case 'sourceLocator.type':
                    case 'targetLocator.type':
                        return `<select class="form-control" data-param="${param}">
                            ${locatorTypes.map(type =>
                                `<option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>`
                            ).join('')}
                        </select>`;
                    case 'selectBy':
                        return `<select class="form-control" data-param="${param}">
                            ${selectByTypes.map(type =>
                                `<option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>`
                            ).join('')}
                        </select>`;
                    case 'seconds':
                        return `<input type="number"
                               class="form-control"
                               data-param="${param}"
                               min="0"
                               value="1">`;
                    default:
                        return `<input type="text"
                               class="form-control"
                               data-param="${param}"
                               placeholder="Enter ${key}">`;
                }
            };

            // Create parameter group (label + input)
            const createParamGroup = (param) => {
                const [key, subKey] = param.split('.');
                const label = subKey ? `${key} (${subKey})` : key;

                return `
                    <div class="form-group mt-2">
                        <label>${label}</label>
                        <div class="input-group">
                            ${createInputField(param, label)}
                        </div>
                    </div>`;
            };

            // Create HTML for action parameters
            const createActionParams = (actionType) => {
                if (!actionDefinitions[actionType]) {
                    return '<p class="text-muted">Select an action type to see its parameters.</p>';
                }

                return actionDefinitions[actionType]
                    .map(param => createParamGroup(param))
                    .join('');
            };

            // Create a new action block
            const createActionBlock = () => {
                const block = document.createElement('div');
                block.className = 'action-block';
                block.innerHTML = `
                    <div class="action-block-header">
                        <h5>Action</h5>
                        <button type="button" class="btn btn-danger btn-sm remove-action-btn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Action Type</label>
                        <select class="form-control action-type-selector">
                            <option value="">-- Select Action --</option>
                            ${Object.keys(actionDefinitions)
                                .map(action => `<option value="${action}">${action.charAt(0).toUpperCase() + action.slice(1)}</option>`)
                                .join('')}
                        </select>
                    </div>
                    <div class="action-params mt-2"></div>`;
                actionsContainer.appendChild(block);
            };

            // Update action parameters when action type changes
            actionsContainer.addEventListener('change', e => {
                if (e.target.matches('.action-type-selector')) {
                    const actionType = e.target.value;
                    const paramsDiv = e.target.closest('.action-block').querySelector('.action-params');
                    paramsDiv.innerHTML = createActionParams(actionType);
                    updatePreview();
                }
            });

            const updatePreview = () => {
                const actions = Array.from(document.querySelectorAll('.action-block')).map(block => {
                    const type = block.querySelector('.action-type-selector')?.value;
                    if (!type) return null;
                    const action = { action: type };
                    const params = {};

                    block.querySelectorAll('[data-param]').forEach(input => {
                        const key = input.dataset.param;
                        const value = input.type === 'checkbox' ? input.checked : input.value;
                        const keys = key.split('.');
                        let current = params;
                        keys.forEach((k, i) => {
                            if (i === keys.length - 1) current[k] = value;
                            else current = current[k] = current[k] || {};
                        });
                    });

                    return { ...action, ...params };
                }).filter(Boolean);

                jsonPreview.textContent = JSON.stringify(actions, null, 2);
            };

            actionsContainer.addEventListener('input', updatePreview);

            actionsContainer.addEventListener('click', e => {
                if (e.target.closest('.remove-action-btn')) {
                    e.target.closest('.action-block').remove();
                    updatePreview();
                }
            });

            addActionBtn.addEventListener('click', createActionBlock);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                let actions;
                try {
                    actions = JSON.parse(jsonPreview.textContent);
                    if (!Array.isArray(actions) || actions.length === 0) {
                        showToast('Add at least one action.', "error");
                        return;
                    }
                } catch {
                    showToast('Invalid JSON.', "error");
                    return;
                }

                const body = {
                    browser: form.browser.value,
                    stopOnFailure: form.stopOnFailure.value === 'true',
                    testDataId: form['test-data'].value ? parseInt(form['test-data'].value) : null,
                    actions
                };

                const resultsContainer = document.getElementById('results-container');
                const resultsOutput = document.getElementById('results-output');

                resultsContainer.style.display = 'block';
                resultsOutput.textContent = 'Running test...';

                try {
                    const res = await fetch('/api/tests/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    if (data.testRunId) pollForResults(data.testRunId);
                    else resultsOutput.textContent = 'Start error: ' + JSON.stringify(data);
                } catch (err) {
                    console.error(err);
                    resultsOutput.textContent = 'Fetch error.';
                }
            });

            const pollForResults = (testRunId) => {
                const resultsOutput = document.getElementById('results-output');
                const interval = setInterval(async () => {
                    try {
                        const res = await fetch(`/api/tests/results/${testRunId}`);
                        const data = await res.json();
                        if (data.status === 'finished') {
                            clearInterval(interval);
                            resultsOutput.textContent = JSON.stringify(data.results, null, 2);
                        } else if (data.status === 'not_found') {
                            clearInterval(interval);
                            resultsOutput.textContent = 'Results not found.';
                        }
                    } catch (err) {
                        clearInterval(interval);
                        resultsOutput.textContent = 'Polling error.';
                    }
                }, 2000);
            };

            if (!actionsContainer.querySelector('.action-block')) createActionBlock();
        };
        let runTestPageInitialized = false;

        const observer = new MutationObserver(() => {
            if (!runTestPageInitialized && document.querySelector('#test-builder-form')) {
                runTestPageInitialized = true;
                requestIdleCallback(initRunTestPage);
            }
        });

        observer.observe(document.body, { childList: true, subtree: true });

// Also run once on initial load if content is already there
        if (document.querySelector('#test-builder-form')) {
            runTestPageInitialized = true;
            requestIdleCallback(initRunTestPage);
        }


    });

    function showPopupMessage(message) {
        const popup = document.getElementById('popup-message');
        popup.textContent = message;
        popup.style.display = 'block';

        setTimeout(() => {
            popup.style.display = 'none';
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Show loader, hide form
        document.getElementById('settings-loader').style.display = 'block';
        document.getElementById('settings-form').style.display = 'none';

        // Fetch settings via GET request
        fetch('/api/settings')
            .then(response => response.json())
            .then(data => {
                // Populate form with settings data
                document.getElementById('concurrency').value = data.concurrency;

                // Hide loader, show form
                document.getElementById('settings-loader').style.display = 'none';
                document.getElementById('settings-form').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading settings:', error);
                showToast('Error loading settings. Please refresh the page.', 'error');
            });
    });
</script>
</body>
</html>
